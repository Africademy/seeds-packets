<h2 id="examples">Examples</h2>

<h3>Complete Palette</h3>
<table>
  <thead>
    <th scope="col">
      Name
      <select id="colors-name">
        <option value="palette" selected>Palette</option>
        <option value="sass">Sass</option>
        <option value="javascript">Javascript</option>
        <option value="swift">Swift</option>
        <option value="android">Android XML</option>
        <option value="python">Python</option>
      </select>
    </th>
    <th scope="col">
      Value
      <select id="colors-value">
        <option value="value" selected>Hex</option>
        <option value="rgb">RGB()</option>
      </select>
    </th>
  </thead>
</table>

<script id="colors" type="text/html">
  <tbody>
    <tr>
      <th colspan="2" scope="col" style="text-align: left;">
        <h4><%= category %></h4>
      </th>
    </tr>
    <%= rows %>
  </tbody>
</script>

<script id="colors-row" type="text/html">
  <tr>
    <th scope="row" style="text-align: left;">
      <span data-lang="palette" style="display: block"><%= palette %></span>
      <pre data-lang="sass" style="display: none"><%= sass %></pre>
      <pre data-lang="javascript" style="display: none"><%= javascript %></pre>
      <pre data-lang="swift" style="display: none"><%= swift %></pre>
      <pre data-lang="android" style="display: none"><%= android %></pre>
      <pre data-lang="python" style="display: none"><%= python %></pre>
    </th>
    <td>
      <span style="display: inline-block; width: 2em; height: 2em; background: <%= value %>; border: 1px solid #f3f4f4"></span>
      <span>
        <pre data-value="value" style="display: inline-block"><%= value %></pre>
        <pre data-value="rgb" style="display: none"><%= rgb %></pre>
      </span>
    </td>
  </tr>
</script>

{% include_relative _generated/colors.html %}

<script>
  // TODO: Babel this stuff up
  // TODO: Get rid of all this jQuery and do it with React or at least vanilla JS
  (function($, _, seedsColors) {

    var nameInputEl = document.getElementById('colors-name');
    var valueInputEl = document.getElementById('colors-value');
    var nameType = nameInputEl.value;
    var valueType = valueInputEl.value;

    var nearestColorInputEl = document.getElementById('color-closest');
    var nearestColorNameEl = document.getElementById('color-closest-name');
    var nearestColorValueEl = document.getElementById('color-closest-value');
    var $colorSelectedSwatch = $('#color-closest-selected');
    var $colorFoundSwatch = $('#color-closest-found');

    var colorsWithoutBambu = _.filter(seedsColors, function(color) {
      return color.category != 'bambu';
    });

    function renderColors() {
      var categories = _.uniq(_.map(seedsColors, 'category'));
      var $table = $('table');
      var colorsTemplate = _.template($('#colors').html());
      var colorsRowTemplate = _.template($('#colors-row').html());

      _.each(categories, function(category) {
        var rows = _.map(seedsColors, function(color) {
          if (color.category !== category) {
            return;
          }
          return colorsRowTemplate(color)
        }).join('');
        $table.append(colorsTemplate({
          rows: rows,
          category: _.upperFirst(category)
        }))
      });

      $('#colors-name').on('change', function() {
        $('[data-lang="' + this.value + '"]')
          .show()
          .siblings()
          .hide();

        nameType = this.value;
      });

      $('#colors-value').on('change', function() {
        $('[data-value="' + this.value + '"]')
          .css('display', 'inline-block')
          .siblings()
          .hide();

        valueType = this.value;
      });
    }

    function hexToRgb(hex) {
      // Expand shorthand form (e.g. "03F") to full form (e.g. "0033FF")
      var shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
      hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
      });
      var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : null;
    };

    function rgbToXyz(rgb) {
      var _r = (rgb.r / 255),
        _g = (rgb.g / 255),
        _b = (rgb.b / 255);

      if (_r > 0.04045) {
        _r = Math.pow(((_r + 0.055) / 1.055), 2.4);
      } else {
        _r = _r / 12.92;
      }

      if (_g > 0.04045) {
        _g = Math.pow(((_g + 0.055) / 1.055), 2.4);
      } else {
        _g = _g / 12.92;
      }

      if (_b > 0.04045) {
        _b = Math.pow(((_b + 0.055) / 1.055), 2.4);
      } else {
        _b = _b / 12.92;
      }

      _r = _r * 100;
      _g = _g * 100;
      _b = _b * 100;

      var X = _r * 0.4124 + _g * 0.3576 + _b * 0.1805,
        Y = _r * 0.2126 + _g * 0.7152 + _b * 0.0722,
        Z = _r * 0.0193 + _g * 0.1192 + _b * 0.9505;

      return [X, Y, Z];
    };

    function xyzToLab(xyz) {
      var ref_X =  95.047,
        ref_Y = 100.000,
        ref_Z = 108.883,
        _X = xyz[0] / ref_X,
        _Y = xyz[1] / ref_Y,
        _Z = xyz[2] / ref_Z;

      if (_X > 0.008856) {
        _X = Math.pow(_X, (1/3));
      } else {
        _X = (7.787 * _X) + (16 / 116);
      }

      if (_Y > 0.008856) {
        _Y = Math.pow(_Y, (1/3));
      } else {
        _Y = (7.787 * _Y) + (16 / 116);
      }

      if (_Z > 0.008856) {
        _Z = Math.pow(_Z, (1/3));
      } else {
        _Z = (7.787 * _Z) + (16 / 116);
      }

      var CIE_L = (116 * _Y) - 16,
        CIE_a = 500 * (_X - _Y),
        CIE_b = 200 * (_Y - _Z);

      return [CIE_L, CIE_a, CIE_b];
    };

    function cie1994(x, y, isTextiles) {
      var x = {l: x[0], a: x[1], b: x[2]},
        y = {l: y[0], a: y[1], b: y[2]},
        labx = x,
        laby = y,
        k2,
        k1,
        kl,
        kh = 1,kc = 1;

      if (isTextiles) {
        k2 = 0.014;
        k1 = 0.048;
        kl = 2;
      } else {
        k2 = 0.015;
        k1 = 0.045;
        kl = 1;
      }

      var c1 = Math.sqrt(x.a * x.a + x.b * x.b),
        c2 = Math.sqrt(y.a * y.a + y.b * y.b),
        sh = 1 + k2 * c1,
        sc = 1 + k1 * c1,
        sl = 1,
        da = x.a - y.a,
        db = x.b - y.b,
        dc = c1 - c2,
        dl = x.l - y.l,
        dh = Math.sqrt(Math.abs(da * da + db * db - dc * dc));

      return Math.sqrt(Math.pow((dl/(kl * sl)),2) + Math.pow((dc/(kc * sc)),2) + Math.pow((dh/(kh * sh)),2));
    };

    function hexToLab(hex) {
      return xyzToLab(rgbToXyz(hexToRgb(hex)));
    };

    renderColors();

    $(nearestColorInputEl).on('input', function() {
      var val = this.value,
          includeBambu = document.getElementById('color-include-bambu').checked,
          colorsToCheck = includeBambu ? seedsColors : colorsWithoutBambu,
          lab,
          closestColor,
          distance;

      if (!val.match(/^#?(?:[0-9a-fA-F]{3}){1,2}$/)) {
        return;
      }

      lab = hexToLab(val);
      closestColor = 0;
      distance = cie1994(lab, hexToLab(colorsToCheck[0].value));

      _.each(colorsToCheck, function(color, i) {
        var thisDistance = cie1994(lab, hexToLab(color.value));
        if (thisDistance < distance) {
          closestColor = i;
          distance = thisDistance;
        }
      });

      nearestColorNameEl.value = colorsToCheck[closestColor][nameType];
      nearestColorValueEl.value = colorsToCheck[closestColor][valueType];

      $colorSelectedSwatch.css('background', String(this.value).slice(0,1) === '#' ? this.value : '#' + this.value);
      $colorFoundSwatch.css('background', colorsToCheck[closestColor].value);
    });

    $(nearestColorNameEl).add(nearestColorValueEl).on('focus', function() {
      this.select();
    });

    $(nameInputEl).add(valueInputEl).add('#color-include-bambu').on('change', function() {
      $(nearestColorInputEl).trigger('input');
    });
    
  })(window.jQuery, window._, window.seedsColors);
</script>